<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>写一个字</title>
	<style>
		#canvas {
			display: block;
			margin: 0 auto;
		}
	</style>
</head>
<body>
<canvas id="canvas">
	您的浏览器不支持canvas!
</canvas>
<script src="lib/jquery.min.js"></script>
<script>
	// canvas初始大小
	var canvasWidth = 600;
	var canvasHeight = canvasWidth;

	var isMouseDown = false;
	var lastLoc = {x:0,y:0};
	var lastTimestamp = 0;
	var lastLineWidth = -1;

	var canvas = document.getElementById("canvas");
	var context = canvas.getContext("2d");

	canvas.width = canvasWidth;
	canvas.height = canvasHeight;
	// 鼠标事件
	// 按下鼠标事件
	canvas.onmousedown = function(e) {
		e.preventDefault();
		isMouseDown = true;
		// console.log("mouse down!");
		lastLoc = windowToCanvas(e.clientX,e.clientY);
		//alert(location.x+","+location.y);
		lastTimestamp = new Date().getTime();
	};
	// 鼠标放下
	canvas.onmouseup = function(e) {
		e.preventDefault();
		isMouseDown = false;
		// console.log("mouse up!");
	};
	// 鼠标移出
	canvas.onmouseout = function(e) {
		e.preventDefault();
		isMouseDown = false;
		// console.log("mouse out!");
	};
	// 鼠标移动
	canvas.onmousemove = function(e) {
		e.preventDefault();
		if (isMouseDown) {
			// draw
			// console.log("mouse move!");
			var curLoc = windowToCanvas(e.clientX,e.clientY);
			var s = calcDistance(curLoc,lastLoc);
			var curTimestamp = new Date().getTime();
			var t = curTimestamp - lastTimestamp;

			var lineWidth = calcLineWidth(t,s);

			context.beginPath();
			context.moveTo(lastLoc.x,lastLoc.y);
			context.lineTo(curLoc.x,curLoc.y);

			context.strokeStyle = "black";
			context.lineWidth = lineWidth;
			context.lineCap = "round";
			context.lineJoin = "round";

			context.stroke();

			lastLoc = curLoc;	
			lastTimestamp = curTimestamp;	
		};
	};

	// 减少硬编码
	var maxLineWidth = 30;
	var minLineWidth = 1;
	var maxStrokeV = 10;
	var minStrokeV = 0.1;
	
	function calcLineWidth(t,s) {
		var v = s/t;
		var resultLineWidth;

		if(v <= 0.1) {
			resultLineWidth = maxLineWidth;
		}else if(v >= 10){
			resultLineWidth = minLineWidth;
		}else{
			resultLineWidth = maxLineWidth-(v-minStrokeV)/(maxStrokeV-minStrokeV)*(maxLineWidth-minLineWidth);
		}

		if(lastLineWidth == -1){
			return resultLineWidth;
		}

		return lastLineWidth*2/3 + resultLineWidth*1/3;	
	}

	function calcDistance(loc1,loc2) {
		return Math.sqrt( (loc1.x-loc2.x)*(loc1.x-loc2.x)+(loc1.y-loc2.y)*(loc1.y-loc2.y) );
	}

	// 定义坐标指针
	function windowToCanvas(x,y) {
		var bbox = canvas.getBoundingClientRect();
		return {x:Math.round(x-bbox.left),y:Math.round(y-bbox.top)};
	}

	// 米字格 
	function drawGrid() {
		context.save();

		context.strokeStyle = "rgb(230,11,9)";

		context.beginPath();
		context.moveTo(3,3);
		context.lineTo(canvasWidth - 3, 3);
		context.lineTo(canvasWidth - 3, canvasHeight - 3);
		context.lineTo(3, canvasHeight - 3);
		context.closePath();

		context.lineWidth = 6;
		context.stroke();

		context.beginPath();
		context.moveTo(0,0);
		context.lineTo(canvasWidth,canvasHeight);

		context.moveTo(canvasWidth,0);
		context.lineTo(0,canvasHeight);

		context.moveTo(canvasWidth/2,0);
		context.lineTo(canvasWidth/2,canvasHeight);

		context.moveTo(0,canvasHeight/2);
		context.lineTo(canvasWidth,canvasHeight/2);

		context.lineWidth = 1;
		context.stroke();

		context.restore(); 
	}
	$(function(){
		drawGrid();
	});	
</script>	
</body>
</html>